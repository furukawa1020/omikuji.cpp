#include <iostream>
#include <vector>
#include <string>
#include <thread>
#include <chrono>
#include <ctime>
#include <cstdlib>
#include <algorithm>

using namespace std;
using namespace chrono;

void sleep_ms(int ms){ this_thread::sleep_for(milliseconds(ms)); }
void clear(){ cout << "\033[2J\033[1;1H"; }
void beep(){ cout << "\a" << flush; }

string color(int code){ return "\033[1;" + to_string(code) + "m"; }
string reset(){ return "\033[0m"; }

// ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼æ–‡å­—ï¼ˆã‚²ãƒ¼ãƒŸãƒ³ã‚°ï¼‰
void rainbow_print(const string& s, int delay=8){
    vector<int> cols = {31,33,32,36,34,35};
    for (int i=0;i<(int)s.size();i++){
        cout << "\033[1;" << cols[i % (int)cols.size()] << "m" << s[i] << "\033[0m";
        if(delay>0) sleep_ms(delay);
    }
    cout << "\n";
}

void progress(const string& label, int steps, int ms){
    vector<string> spin = {"â ‹","â ™","â ¹","â ¸","â ¼","â ´","â ¦","â §","â ‡","â "};
    for(int i=0;i<steps;i++){
        cout << "\r" << color(36) << spin[i % (int)spin.size()] << reset()
             << " " << label << " " << color(35) << "â—†" << reset() << flush;
        if(i%3==0) beep();
        sleep_ms(ms);
    }
    cout << "\r" << string(40,' ') << "\r";
}

struct Fortune{
    string tier;     // ãƒ¬ã‚¢åº¦
    string name;     // çµæœå
    string msg;      // ä¸€è¨€
    int weight;      // å‡ºç¾ç¢ºç‡ï¼ˆç›¸å¯¾ï¼‰
};

int pick_index_by_weight(const vector<Fortune>& pool){
    int sum=0; for(auto& f: pool) sum += f.weight;
    int r = rand() % sum;
    int acc=0;
    for(int i=0;i<(int)pool.size();i++){
        acc += pool[i].weight;
        if(r < acc) return i;
    }
    return (int)pool.size()-1;
}

string tier_color(const string& tier){
    if(tier=="UR") return color(35);
    if(tier=="SSR") return color(33);
    if(tier=="SR") return color(36);
    if(tier=="R")  return color(32);
    return color(37);
}

int main(){
    srand((unsigned)time(nullptr));

    // 10é€£ãƒ—ãƒ¼ãƒ«ï¼ˆå¥½ãã«æ”¹é€ ã—ã¦OKï¼‰
    vector<Fortune> pool = {
        {"UR",  "ç¥å‰", "ä»Šå¹´ã€å‹ã¡ç­‹ã—ã‹ãªã„",  2},
        {"UR",  "è¦‡å‰", "å¼·ã„ã€‚å›ã›ã€‚é€²ã‚ã€‚",    3},
        {"SSR", "è¶…å‰", "å…¨éƒ¨ã¤ãªãŒã£ã¦å¾Œã§åŠ¹ã", 8},
        {"SSR", "å¤§å‰", "ä¸–ç•Œã¯ã¾ã ã¾ã é¢ç™½ããªã‚‹", 10},
        {"SR",  "å¼·å‰", "è¿·ã£ã¦ã‚‚å‰é€²ã—ã¦ã‚‹",   18},
        {"SR",  "ç¥å‰", "ç”Ÿå­˜ã—ã¦ã‚‹ã ã‘ã§å„ªå‹", 18},
        {"R",   "ä¸­å‰", "ç¸ãŒå¾Œã‹ã‚‰åŠ¹ã„ã¦ãã‚‹", 25},
        {"R",   "å°å‰", "ã¡ã‚ƒã‚“ã¨ç©ã¿ä¸ŠãŒã‚‹",   28},
        {"N",   "å‰",   "æ€ã£ãŸã‚ˆã‚Šæ‚ªããªã„",   35},
        {"N",   "æœ«å‰", "æ¥å¹´ã«é…å»¶å®Ÿè¡Œã•ã‚Œã‚‹",  30}
        // å‡¶ã‚’å…¥ã‚ŒãŸã„ãªã‚‰ã“ã“ã«è¿½åŠ ã—ã¦weightèª¿æ•´
    };

    clear();
    rainbow_print("ğŸ Cppç¥ç¤¾ 10é€£ãŠã¿ãã˜ã‚¬ãƒãƒ£ ğŸ", 6);
    cout << "\n";
    cout << "Enterã§10é€£ï¼ˆæŠ¼ã—ã¦ï¼‰: ";
    cin.get();

    clear();
    cout << R"(
        â›©  â›©  â›©
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        C++  ç¥ ç¤¾
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    )" << "\n";

    progress("ãŠã¿ãã˜ç®±ã‚’ã‚²ãƒ¼ãƒŸãƒ³ã‚°ã«æŒ¯ã£ã¦ã„ã¾ã™â€¦", 55, 55);

    clear();
    rainbow_print("ğŸ° 10é€£ ã„ãã¾ã™ ğŸ°", 8);
    cout << "\n";

    vector<int> counts(pool.size(), 0);
    vector<int> picked(10);

    for(int i=0;i<10;i++){
        progress("æŠ½é¸ä¸­", 22, 35);

        int idx = pick_index_by_weight(pool);
        picked[i]=idx;
        counts[idx]++;

        // 1æ ãšã¤ãƒ‰æ´¾æ‰‹ã«å‡ºã™
        auto &f = pool[idx];
        string c = tier_color(f.tier);

        cout << c << "ã€" << f.tier << "ã€‘ " << f.name << reset()
             << "  - " << f.msg << "\n";

        // ãƒ¬ã‚¢ã¯éŸ³å¤šã‚
        if(f.tier=="UR"){ for(int k=0;k<6;k++){ beep(); sleep_ms(40);} }
        else if(f.tier=="SSR"){ for(int k=0;k<3;k++){ beep(); sleep_ms(60);} }
        else { beep(); }

        sleep_ms(120);
    }

    // ã‚µãƒãƒª
    cout << "\n";
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    rainbow_print("ğŸ“Š 10é€£ã‚µãƒãƒª", 0);
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    int ur=0, ssr=0;
    for(int i=0;i<(int)pool.size();i++){
        if(counts[i]==0) continue;
        if(pool[i].tier=="UR") ur += counts[i];
        if(pool[i].tier=="SSR") ssr += counts[i];

        cout << tier_color(pool[i].tier)
             << pool[i].tier << reset()
             << " " << pool[i].name
             << " Ã—" << counts[i] << "\n";
    }

    cout << "\n";
    if(ur>=1){
        cout << color(35) << "âœ¨ URå‡ºãŸã€‚ä»Šæ—¥ã¯å‹ã¡ã€‚" << reset() << "\n";
    }else if(ssr>=2){
        cout << color(33) << "âœ¨ SSRè¤‡æ•°ã€‚ä¸ŠæŒ¯ã‚Œã€‚" << reset() << "\n";
    }else if(ssr>=1){
        cout << color(33) << "âœ¨ SSRã‚ã‚Šã€‚ååˆ†ã€‚" << reset() << "\n";
    }else{
        cout << color(36) << "âœ¨ ãƒ¬ã‚¢ã¯â€¦æ¥å¹´ã«é…å»¶å®Ÿè¡Œã•ã‚Œã‚‹ã€‚" << reset() << "\n";
    }

    cout << "å¼•ã„ãŸæ™‚åˆ»: " << time(nullptr) << "\n";
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

    return 0;
}
